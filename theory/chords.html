<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chords</title>
<link rel="stylesheet" href="../style/styles.css?v=6" />

<body>
    <main>
        <div class='title'> CHORDS</div>
        <div class='options-row'>
            <div class='option'>
                <label>Root</label>
                <select id='tonics'></select>
            </div>
            <div class='option'>
                <label>Octave</label> 
                <select id='octaves'>
                    <option value='1'>1</option>
                    <option value='2' selected>2</option>
                    <option value='3'>3</option>
                    <option value='4'>4</option>
                    <option value='5'>5</option>
                    <option value='6'>6</option>
                    <option value='7'>7</option>
                </select>
            </div>
            <div class='option'>
                <label>Wave form</label>
                <select id='waveForm'>
                    <option value='sine'>sine</option>
                    <option value='square'>square</option>
                    <option value='triangle'>triangle</option>
                    <option value='sawtooth' selected>sawtooth</option>
                </select>
            </div>
            <div class='option'>
                <label>Seconds</label>
                <select id='duration'>
                    <option value='0.10'>0.10</option>
                    <option value='0.25'>0.25</option>
                    <option value='0.50'>0.50</option>
                    <option value='0.75'>0.75</option>
                    <option value='1.00'>1.00</option>
                    <option value='2.00'>2.00</option>
                    <option value='4.00' selected>4.00</option>
                </select>
            </div>
            <!-- <label>Show frequencies</label>
            <input id='showFreq' type='checkbox' /> -->
        </div>
        <canvas id='graph'></canvas>
        <div class="button-row" id="buttons" />  
    </main>
    <div class="options-row" id='notes'></div>   
</body>

<script src="../js/AudioTone.js"></script>
<script src="../js/AudioGraph.js"></script>

<script>
    const graphOptions = {
        backgroundColor: 'lightyellow',
        foregroundColor: 'rgb(14, 93, 196)',
    }
    const tone = new AudioTone()

    const NOTES = ['A','A#','B','C','C#','D','D#','E','F','F#','G','G#']
    const CHORDS = {
        'major':                 [0, 4, 3],
        'minor':                 [0, 3, 4],
        'diminished':            [0, 3, 3],
        'augmented':             [0, 4, 4],
        'dominant 7th':          [0, 4, 3, 3],
        'diatonic dominant 7th': [7, 4, 3, 3],
        'major 7th':             [0, 4, 3, 4],
        'minor 7th':             [0, 3, 4, 3],
        'diminished 7th':        [0, 3, 3, 3],
    }

    for (let i = 0; i < NOTES.length; i++) {
        const note = NOTES[i]
        const option = document.createElement('option')
        option.textContent = note
        option.value = i
        tonics.appendChild(option)
    }

    for (const chordName of Object.keys(CHORDS)) {
        const div = document.createElement('div')
        const button = document.createElement('button')
        button.id = chordName
        button.textContent = chordName
        button.onclick = () => { 
            notes.textContent = ''
            playChord(chordName) 
        }
        div.appendChild(button)
        buttons.appendChild(div)
    }

    // placeholder
    const graph = new AudioGraph(document.querySelector('#graph'), tone.audioContext, graphOptions)
    document.querySelector('#graph').style.height = document.querySelector('main').offsetHeight + 'px'

    async function playChord(name) {
        tone.stop()
        const chordSteps = CHORDS[name]
        const tonicIndex = Number(tonics.value)
        const seconds = Number(duration.value)
        let promises = []
        let index = 0
        const graph = new AudioGraph(document.querySelector('#graph'), tone.audioContext, graphOptions)
        document.querySelector('#graph').style.height = document.querySelector('main').offsetHeight + 'px'

        for (const steps of chordSteps) {
            index += steps
            promises.push(tone.play(selectFrequency(tonicIndex, index), seconds, waveForm.value, {analyser:graph.analyser}))
        }
        console.log('scale begin', name)
        Promise.all(promises)
            .catch(error => console.log(error.message))
    }

    function selectFrequency(tonicIndex, index) {
        const frequency = tone.semitoneStep(tonicIndex, index, octaves.value)
        notes.textContent += `${NOTES[(tonicIndex + index) % NOTES.length]} `
        // if (showFreq.checked)
        //     notes.textContent += `[${(frequency.toFixed(3))}] `
        return frequency
    }
</script>
